//metaschema-node.js - pre alpha - by hideki yamamoto
var http=require('http'),fs=require('fs'),url=require('url'),path=require("path"),Stream=require('stream'),util=require('util'),MongoClient = require('mongodb').MongoClient;var ObjectID=require('mongodb').ObjectID;
//var replaceStream = require('replacestream');
var mime={mp3:'audio/mpeg',wav:'audio/x-wav',html:'text/html',htm:'text/html',xml:'text/xml',txt:'text/plain',js:'text/javascript; charset=utf-8',json:'application/javascript; charset=utf-8'};
//------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------------------------
var DEFAULTCONFIG={port:8080,ip:'0.0.0.0',dirname:'./static',defaultfile:'index.html',mongoUrl:'mongodb://localhost:27017/metaschema',
	selectParameter:'jselect',dataParameter:'jdata',pageParameter:'page',urltorecord:{redirect:'/?',parameter:'_id'}
};
Metaschema={config:DEFAULTCONFIG,metacache:null,aabb:function(a,b){if(a){if(b){for(k in b){a[k]=b[k]}}return a}else{return b}},
//------------------------------------------------------------------------------------------------------
apply:function(oo,_next){if(oo){this.config=this.aabb(this.config,oo);}},
//------------------------------------------------------------------------------------------------------ json to xml
JSON2xmldoc:function(o,n){return '<?xml version="1.0" encoding="UTF-8"?>\n'+this.o2xml(n,o)},
o2xml:function(n,o){if(Array.prototype.isPrototypeOf(o)){return this.a2xml(n,o);}else if(typeof(o)=='object'){return this._o2xml(n,o);}else{return this.v2xml(n,o);}},
_o2xml:function(n,o){if(n.indexOf('_')==0){n=n.substr(1);return '<'+n+'>'+o+'</'+n+'>'}var xml='<'+n+'>';var pr;
 for(var prop in o){pr=prop;if(!isNaN(prop)){pr='x'+pr}if(Array.prototype.isPrototypeOf(o[prop])){xml+=this.a2xml(pr,o[prop]);}else if(typeof(o[prop])=='object'){xml+=this._o2xml(pr,o[prop]);}else{xml+=this.v2xml(pr,o[prop]);}}return xml+'</'+n+'>';},
a2xml:function(n,a){var xml='';for(var i=0;i<a.length;i++){if(Array.prototype.isPrototypeOf(a[i])){xml+=this.a2xml(n,a[i]);}else if(typeof(a[i]=='object')){xml+=this._o2xml(n,a[i]);}else{xml+=this.v2xml(n,a[i]);}}return xml;},
v2xml:function(n,v){if(typeof(v)=='function'){return ''}var cd=false;if(typeof(v)=='string'){cd=true;}if(cd){return '<'+n+'><![CDATA['+v+']]></'+n+'>';}else{return '<'+n+'>'+v+'</'+n+'>';}},
//------------------------------------------------------------------------------------------------------ context adaptation
fwd:function(req,res,next,hdr){res.jsonout={requested:req.originalUrl,serveroutput:[]};if(!req.uri){req.uri=url.parse(req.url);}
	if(!req.query){req.query={};var qq=req.uri.query;if(qq){if(qq!=''){qq=qq.trim('?');qq=qq.split('&');var pp='';
		for(var q=0;q<qq.length;q++){pp=qq[q].split('=');req.query[pp[0]]=decodeURIComponent(pp[1])}
	}}}if(!req.body){req.body={}}
	if(!req.item){req.item=function(key){if(req.query[key]){return req.query[key]}if(req.body[key]){return req.body[key]}return null};}
	if(!res.redirect){res.redirect=function(target){this.writeHead(301,{Location:target});this.end();};}
	res.metahead=function(mime,size){if(!mime){mime='text/plain'};var hh={'Content-Type': mime};
		if(size){hh['Content-Type']=size}this.writeHead(200,hh);};
	res.metaend=function(o,mime,size){this.metahead(mime,size);this.end(o);};
	res.jend=function(req,res,mtype,message){
	   res.jsonout.serveroutput[res.jsonout.serveroutput.length]={type:mtype,message:message};
		if(req.item('output')=='xml'){res.metaend(Metaschema.JSON2xmldoc(res.jsonout,'response'),'text/xml;');}
		else{res.metaend(JSON.stringify(res.jsonout),'application/json; charset=utf-8');}return false;};
		hdr(req,res,next);},
//------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------------ GET SERVICE
//------------------------------------------------------------------------------------------------------
get:function(req,res,next){
	var Q=false;var q=req.item(Metaschema.config.selectParameter);
	if(!q){Q={}}else{try{Q=JSON.parse(q)}catch(ex){Q=false;return res.jend(req,res,'error','could not parse json');}}
	//TODO:projection parameter + ensure accesslevel for projection
	//TODO:ensure accesslevel for query (visible,...)
	
	q=req.item('id');if(q){Q._id=q}q=req.item('p');if(q){Q._p=q}q=req.item('k');if(q){Q._k=q}
	q=req.item('rel');if(q){Q.rel=q}
	q=req.item('role');if(q){Q.role=q}
	//TODO: pattern - time - owned_by - modified_by + _id,_k,_p MULTI support
	//------------------------------------------------ query normalize
	var qq;var qi=0;
	if(Q._id){Q._id=ObjectID(Q._id)}if(Q._p){Q._p=ObjectID(Q._p)}if(Q._k){Q._p=ObjectID(Q._k)}
	if(Q.rel){var rr=[];qq=Q.rel.split(',');for(qi=0;qi<qq.length;qi++){if(qq[qi]!=''){rr[rr.length]=ObjectID(qq[qi])}}Q.rel={$elemMatch:{key:{$in:rr}}}}
	if(Q.role){var rgx=new RegExp('.*'+Q.role.replace(/ /g,'.*')+'.*');
		if(!Q.rel){Q.rel={$elemMatch:{r:rgx}}}else{Q.rel.$elemMatch.r=rgx}
		delete Q.role;}
	res.jsonout.dbquery=Q;
	if(Q){MongoClient.connect(Metaschema.config.mongoUrl,function(err,db){if(err){return res.jend(req,res,'error',err);}		
		db.collection('dat').find(Q).toArray(function(err,rows){db.close();if(err){return res.jend(req,res,'error',err);}
			res.jsonout.doc=rows;
			res.jend(req,res,'success','command was executed');
});});}},
//------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------------ SET SERVICE
//------------------------------------------------------------------------------------------------------
	set:function(req,res){res.metaend(JSON.stringify({requested:req.originalUrl,doc:'todo'}), 'application/json; charset=utf-8');},
//------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------------ ADD SERVICE
//------------------------------------------------------------------------------------------------------
	add:function(req,res){
		var Q=JSON.parse(req.getquery(Metaschema.config.dataParameter));
		//TODO:Ensure fields
		if(Q._id){/*eroor*/}
		if(Q._k){/*check , id*/}
		if(Q._p){/*check , id*/}
		if(Q.created_by){/*always override + warning*/}
		if(Q.modified_by){/*always override + warning*/}
		
		
		//TODO:Ensure sec
		MongoClient.connect(Metaschema.config.mongoUrl,function(err,db){if(err){return res.jend(req,res,'error',err);}
			db.collection('dat').insert(Q).toArray(function(err,rows){db.close();if(err){return res.jend(req,res,'error',err);}
				res.metaend(JSON.stringify({requested:req.originalUrl,doc:rows}), 'application/json; charset=utf-8');
});});},
//------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------------ DEL SERVICE
//------------------------------------------------------------------------------------------------------
del:function(req,res){res.jsonout={requested:req.originalUrl};
	var jq=req.item(Metaschema.config.selectParameter);
	/*todo:compose if multi*/
	if(!jq){jq='{invalid:""invalid"}'}
	try{jq=JSON.parse(jq)}catch(ex){return res.jend(req,res,'error','could not parse json');}
	if(!jq._id){return res.jend(req,res,'error','deletion query must include one or more _id');}
	else{jq._id=ObjectID(jq._id);
MongoClient.connect(Metaschema.config.mongoUrl,function(err,db){if(err){return res.jend(req,res,'error',err);}
	db.collection('dat').remove(jq,function(err,rows){db.close();if(err){return res.jend(req,res,'error',err);}
		return res.jend(req,res,'confirm','command was executed');
});});}},
//------------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------- LINK SERVICE
//------------------------------------------------------------------------------------------------------
link:function(req,res,next){
	var vr1=req.item('r1');if(!vr1){return res.jend(req,res,'error','Parameter r1 is mandatory');}
	var vr2=req.item('r2');if(!vr2){return res.jend(req,res,'error','Parameter r2 is mandatory');}
	vr1=ObjectID(vr1);vr2=ObjectID(vr2);var jr1=false;var jr2=false;
	var vrr=req.item('role')||'default';/*todo chooose if allow multi rel or not*/
	var vry=req.item('meta');
MongoClient.connect(Metaschema.config.mongoUrl,function(err,db){																	if(err){return res.jend(req,res,'error',err);}
 db.collection('dat').find({_id:vr1}).toArray(function(err,rows){																	if(err){db.close();return res.jend(req,res,'error',err);}  jr1=rows[0];
  db.collection('dat').find({_id:vr2}).toArray(function(err,rows){																if(err){db.close();return res.jend(req,res,'error',err);}	jr2=rows[0];
	db.collection('dat').update({_id:vr1},{$pull:{rel:{key:vr2}}},function(err,rows){										if(err){db.close();return res.jend(req,res,'error',err);}
	 db.collection('dat').update({_id:vr1},{$push:{rel:{key:vr2,n:jr2.name,p:jr2._p,r:vrr}}},function(err,rows){	if(err){db.close();return res.jend(req,res,'error',err);}
	  db.collection('dat').update({_id:vr2},{$pull:{rel:{key:vr1}}},function(err,rows){										if(err){db.close();return res.jend(req,res,'error',err);}
		db.collection('dat').update({_id:vr2},{$push:{rel:{key:vr1,n:jr1.name,p:jr1._p,r:vrr}}},function(err,rows){	if(err){db.close();return res.jend(req,res,'error',err);}
		 db.close();return res.jend(req,res,'confirm','command was executed');
});});});});});});});},
//------------------------------------------------------------------------------------------------------
//--------------------------------------------------------------------------------------- UNLINK SERVICE
//------------------------------------------------------------------------------------------------------
unlink:function(req,res,next){
	var vr1=req.item('r1');if(!vr1){return res.jend(req,res,'error','Parameter r1 is mandatory');}
	var vr2=req.item('r2');if(!vr2){return res.jend(req,res,'error','Parameter r2 is mandatory');}
	vr1=ObjectID(vr1);vr2=ObjectID(vr2);var jr1=false;var jr2=false;
	var vrr=req.item('role')||'default';/*todo chooose if allow multi rel or not*/
MongoClient.connect(Metaschema.config.mongoUrl,function(err,db){						  if(err){return res.jend(req,res,'error',err);}
 db.collection('dat').update({_id:vr1},{$pull:{rel:{key:vr2}}},function(err,rows){ if(err){db.close();return res.jend(req,res,'error',err);}
  db.collection('dat').update({_id:vr2},{$pull:{rel:{key:vr1}}},function(err,rows){if(err){db.close();return res.jend(req,res,'error',err);}
	db.close();return res.jend(req,res,'confirm','command was executed');
});});});},
//------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------- DB RESET SERVICE
//------------------------------------------------------------------------------------------------------
	reset:function(req,res,next){
MongoClient.connect(Metaschema.config.mongoUrl,function(err,db){if(err){return res.jend(req,res,'error',err);}
	db.collection('user').drop(function(err,out){if(err){db.close();return res.jend(req,res,'error',err);}
	db.collection('dat').drop(function(err,out){if(err){db.close();return res.jend(req,res,'error',err);}
		db.createCollection('user',function(err){if(err){db.close();return res.jend(req,res,'error',err);}
			res.jsonout={};res.jsonout.id_admin=new ObjectID();var idadmin=res.jsonout.id_admin;	
			db.collection('user').insert([
{_id:idadmin,name:'admin',apikey:'admin',desc:'default administrative account',system:true},
{name:'anonymous',apikey:'anonymous',desc:'default anonymous account',system:true}
			],function(err){if(err){db.close();return res.jend(req,res,'error',err);}
				db.createCollection('dat',function(err){if(err){db.close();return res.jend(req,res,'error',err);}
					res.jsonout.id_root=new ObjectID();var idroot=res.jsonout.id_root;
					res.jsonout.id_tag=new ObjectID();var idtag=res.jsonout.id_tag;	
					res.jsonout.id_bin=new ObjectID();var idbin=res.jsonout.id_bin;
					res.jsonout.id_doc=new ObjectID();var iddoc=res.jsonout.id_doc;
					res.jsonout.id_app=new ObjectID();var idapp=res.jsonout.id_app;
					db.collection('dat').insert([
{_id:idroot,_p:idroot,_k:idroot,name:'root',rel:[],meta:[],url:'metaschema-test',desc:'default root node',system:true,_owned_by:idadmin,created:new Date(),_created_by:idadmin,modified:new Date(),_modified_by:idadmin,users:[]},
{_id:idtag,_p:idroot,_k:idroot,name:'tag',rel:[],meta:[{n:'c1',v:'#666666',t:'col'},{n:'c2',v:'#000000',t:'col'}],url:false,desc:'default tag node',system:true,_owned_by:idadmin,created:new Date(),_created_by:idadmin,modified:new Date(),_modified_by:idadmin,users:[]},
{_id:idbin,_p:idroot,_k:idroot,name:'bin',rel:[],meta:[],url:false,desc:'default bin node',system:true,_owned_by:idadmin,created:new Date(),_created_by:idadmin,modified:new Date(),_modified_by:idadmin,users:[]},
{_id:iddoc,_p:idroot,_k:idroot,name:'doc',rel:[],meta:[],url:false,desc:'default docs node',system:true,_owned_by:idadmin,created:new Date(),_created_by:idadmin,modified:new Date(),_modified_by:idadmin,users:[]},
{_id:idapp,_p:idroot,_k:idroot,name:'app',rel:[],meta:[],url:false,desc:'default apps node',system:true,_owned_by:idadmin,created:new Date(),_created_by:idadmin,modified:new Date(),_modified_by:idadmin,users:[]},				
					],function(err){db.close();if(err){return res.jend(req,res,'error',err);}						
							/*todo:create indexes*/
							//todo:loc : { type: "Point", coordinates: [ -73.88, 40.78 ] }
							//todo:createindex for parent
							//todo:createindex for relsid
							//todo:createindex for relsparent		
							fs.writeFile('metaschema.json', 'Just now, we have created this file', function (err) {
								if (err){return res.jend(req,res,'error',err);}
								Metaschema.metacache=res.jsonout;
								res.jend(req,res,'success','database was reset');
							});							
	/*db.createCollection('metacache',function(err){if(err){db.close();throw err}
	db.collection('metacache').insert([res.jout],function(err){
});});*/
});});});});});});});},
metaframe:function(req,res){
   var fn=req.item(Metaschema.config.pageParameter);
	  fn='./'+fn;var st=fs.statSync(fn);if(!st.isDirectory()){var ext=path.extname(fn);
	  if(mime[ext]){res.set('Content-Type',mime[ext]);}
	  var json=req.body[Metaschema.config.dataParameter];if(!json){json=req.query[Metaschema.config.dataParameter]}
	  fs.createReadStream(fn).pipe(replaceStream('%jsondata',json)).pipe(res);
	}else{res.jend(req,res,'error','page must be a file');}
},
//------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------- STATIC SERVER SERVICE
//------------------------------------------------------------------------------------------------------
	servestatic:function(req,res,next){var fn=path.join(Metaschema.config.dirname,req.uri.pathname);
		if(fs.existsSync(fn)){var st=fs.statSync(fn);var flag=true;
			if(st.isDirectory()){flag=false;
				if(Metaschema.config.defaultfile){fn=path.join(fn,Metaschema.config.defaultfile);if(fs.existsSync(fn)){flag=true;st=fs.statSync(fn);}}}
			if(flag){var ext=path.extname(fn);res.metahead(mime[ext],st['size']);fs.createReadStream(fn).pipe(res);
			}else{next()}
		}else{next()}},
//------------------------------------------------------------------------------------------------------
//-------------------------------------------------------------------------------- URL TO RECORD SERVICE
//------------------------------------------------------------------------------------------------------
urltorecord:function(req,res,next){if(req.uri.pathname=='/'){return next()}var uuu=req.uri.pathname.substr(1).split('/');
	MongoClient.connect(Metaschema.config.mongoUrl,function(err,db){if(err){return res.jend(req,res,'error k',err);}
		res.db=db;res.db.collection('dat').find({url:req.uri.originalQuery}).toArray(function(err,rows){if(err){db.close();return res.jend(req,res,'error',err);}
		if(rows.length==1){res.redirect(Metaschema.config.urltorecord.redirect+'&'+Metaschema.config.urltorecord.parameter+'='+rows[0]._id);}
		else{res.db.collection('dat').find({url:uuu[uuu.length-1]}).toArray(function(err,rows){if(err){db.close();return res.jend(req,res,'error',err);}
			if(rows.length==1){res.redirect(Metaschema.config.urltorecord.redirect+'&'+Metaschema.config.urltorecord.parameter+'='+rows[0]._id);}
			else if(rows.length==0){next();/*exit*/}else{res.leftjobs=rows.length;res.dbjobs=[];
				for(var n=0;n<rows.length;n++){res.dbjobs[n]={id:rows[n]._p,uu:uuu,lev:uuu.length-1,result:'/'+rows[n].url,original:rows[n]._id}
this._recursefindandserve(req,res,next,n)}}})}})})},
_recursefindandserve:function(req,res,next,jobidx){res.db.collection('dat').find({_id:res.dbjobs[jobidx].id}).toArray(function(err,rows){
	if(err){db.close();return res.jend(req,res,'error',err);}res.dbjobs[jobidx].lev=res.dbjobs[jobidx].lev-1;
		if(rows.length==0){Metaschema._finishedfindone(req,res,next,jobidx)}
		else{if(rows[0].url){if(rows[0].url!=''){res.dbjobs[jobidx].result='/'+rows[0].url+res.dbjobs[jobidx].result}}
			if(rows[0].url!=res.dbjobs[jobidx].uu[res.dbjobs[jobidx].lev]){Metaschema._finishedfindone(req,res,next,jobidx)}
			else{if((rows[0]._p==0)&&(rows[0]._id==0)){Metaschema._finishedfindone(req,res,next,jobidx);}else{
				if(res.dbjobs[jobidx].lev>0){res.dbjobs[jobidx].id=rows[0]._p;Metaschema._recursefindandserve(req,res,next,jobidx)}
				else{Metaschema._finishedfindone(req,res,next,jobidx)}}}}})},
_finishedfindone:function(req,res,next,jobidx){res.leftjobs--;if(res.leftjobs==0){res.db.close();var flag=false;
	for(var j=0;j<res.dbjobs.length;j++){if(req.uri.pathname==res.dbjobs[j].result){flag=true;res.redirect(Metaschema.config.urltorecord.redirect+'&'+Metaschema.config.urltorecord.parameter+'='+res.dbjobs[j].original)}}
if(!flag){next()/*exit*/}}}
};
//------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------ CLASSES FOR NATIVE MODE
//------------------------------------------------------------------------------------------------------
Metaschema.Handler=function(req,res,handlers){this.req=req;this.res=res;this.handlers=handlers;this.index=-1;this.mindex=handlers.length;};Metaschema.Handler.prototype={
	next:function(){var self=this;this.index++;if(this.index<this.mindex){var flag=false;
		if(this.handlers[this.index].k=='regex'){flag=this.handlers[this.index].e.test(this.req.uri.pathname)}
		else if(this.handlers[this.index].k=='string'){flag=(this.handlers[this.index].e==this.req.uri.pathname)}
		if(flag){this.handlers[this.index].h(this.req,this.res,function(){self.next()});}
		else{this.next();}}else{this.res.end("no module matched the request");}}};
Metaschema.App=function(){this.handlers=[];this.handler=false;this.name='appname'};Metaschema.App.prototype={
	start:function(done){this.server=http.createServer(this.process());this.server.listen(Metaschema.config.port,Metaschema.config.ip);},
	all:function(E,H){if(!E){throw new Error('first and second paramters are mandatory')}
		var K=false;if(RegExp.prototype.isPrototypeOf(E)){K='regex'}else if(String.prototype.isPrototypeOf(E)){K='string'}
		if(K){this.handlers[this.handlers.length]={e:E,k:K,h:H}}else{throw new Error('unsupported format passed to Metaschema.App.all')
}	},
	process:function(req,res,next){var self=this;return function(req,res){Metaschema.fwd(req,res,next,self._process());}},
	_process:function(){var self=this;return function(req,res){var H=new Metaschema.Handler(req,res,self.handlers);H.next();}}
};
//------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------- MIDDLEWARE BEGIN
//------------------------------------------------------------------------------------------------------
Metaschema.express={apply:function(oo){Metaschema.apply(oo)},
		  get:function(req,res,next){Metaschema.fwd(req,res,next,Metaschema.get)},
		  set:function(req,res,next){Metaschema.fwd(req,res,next,Metaschema.set)},
		  add:function(req,res,next){Metaschema.fwd(req,res,next,Metaschema.add)},
		  del:function(req,res,next){Metaschema.fwd(req,res,next,Metaschema.del)},
	    link:function(req,res,next){Metaschema.fwd(req,res,next,Metaschema.link)},
	  unlink:function(req,res,next){Metaschema.fwd(req,res,next,Metaschema.unlink)},
  metaframe:function(req,res,next){Metaschema.fwd(req,res,next,Metaschema.metaframe)},
		reset:function(req,res,next){Metaschema.fwd(req,res,next,Metaschema.reset)},
servestatic:function(req,res,next){Metaschema.fwd(req,res,next,Metaschema.servestatic)},
urltorecord:function(req,res,next){Metaschema.fwd(req,res,next,Metaschema.urltorecord)}};
//------------------------------------------------------------------------------------------------------
//------------------------------------------------------------------------------------------- MODULE END
//------------------------------------------------------------------------------------------------------
module.exports=Metaschema;